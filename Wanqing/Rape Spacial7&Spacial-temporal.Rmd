---
title: "Bayesian 1"
output: html_document
date: "2025-03-27"
---
```{r}
# Load needed libraries:

library(dplyr)        # A package for data manipulation
library(sf)           # Simple feature for R
library(spdep)        # Functions and tests for evaluating spatial patterns 
library(tidyr)        # Tools to create tidy data
library(INLA)         # Integrated Nested Laplace Approximation package
library(ggplot2)      # A package for creating maps and graphs
library(viridis)      # A package providing color palettes 
library(patchwork)    # A package to compose plots

# For tables in RMarkdown
library(knitr)
library(kableExtra)
```
```{r}
###------------------------------ 1. Import and explore the data--------------------------------------------
data <- get("data", envir = .GlobalEnv)
## 1.1 Compute the total number of cases of rapes per year
kable(data %>%
        group_by(year) %>%
         summarise(observed = sum(rape), expected=sum(e_rape)), booktabs = T, caption = "Rapes by year") %>%
  kable_styling(bootstrap_options = "striped", full_width = F, position = "center")

```
```{r}
## 1.2 plot the spatial object
# transform to shape file
carto_up_sf <- st_as_sf(carto_up)

# plot
ggplot() +
  geom_sf(data = carto_up_sf, color = "darkblue", fill = "lightblue") +
  coord_sf() +
  theme_minimal() +
  labs(title = "Uttar Pradesh Districts")
```
```{r}
###--------------------------------- 2. Spatial model------------------------------------------------
## 2.1 Define the neighbors and create the weights list
UP_nb <- poly2nb(carto_up, snap = 1, queen = TRUE)
summary(UP_nb)
```
```{r}
## 2.1 Convert the list of neighbors to inla format using the function nb2WB()
nb2INLA("UP.graph", UP_nb)
UP.ad <- paste(getwd(), "/UP.graph", sep = "")

## 2.2 Aggregate observed and expected cases over geographical areas & Compute standardized morbidity ratios (SMRs)
RESP_DATAagg <- data %>%
  group_by(ID_area) %>%
  summarise(
    observed = sum(rape),      
    expected = sum(e_rape)     
  ) %>%
  rename(O = observed, E = expected) %>%
  mutate(SMR = O / E)
```
```{r}
## 2.3 Produce a spatial map of the aggregated SMRs
#  join the sf object and the data frame RESP_DATAagg
map_data <- left_join(carto_up_sf, RESP_DATAagg, by = c("ID_area" = "ID_area"))

# plot
ggplot(data = map_data) +
  geom_sf(aes(fill = SMR)) +
  scale_fill_viridis_c(
    breaks = c(0, 0.4, 0.6, 0.8, 1, 1.2, 1.4, 1.6, 1.8, 2.0),
    na.value = "grey90"
  ) +
  theme_minimal() +
  labs(title = "the average SMRs of Rape in Uttar Pradesh (Aggregated) over 2001-2014",
       fill = "SMR")
```
```{r}
## 2.4 Fit BYM2 model
# Specify the formula
formula_BYM2 <- O ~ f(ID_area, model = "bym2", graph = UP.ad,
                      scale.model = TRUE,
                      hyper = list(
                        prec = list(prior = "pc.prec",param = c(0.5 / 0.31, 0.01)),
                                phi = list(prior = "pc",param = c(0.5, 2 / 3))
                      ))

# Run the hierarchical Poisson log-linear model in INLA
sBYM.model <- inla(
  formula = formula_BYM2,
  family = "poisson",
  data = RESP_DATAagg,
  E = E,
  control.compute = list(waic = TRUE)
)
```
```{r}
## 2.5 Obtain the posterior summary statistics (mean and posterior probability that the residual is above 1 - (or log-residual is above 0)) of the parameters of interest:

# Relative risks
RR_sBYM <- sapply(1:70, function(i) {
  inla.emarginal(function(x) exp(x), sBYM.model$marginals.random$ID_area[[i]])
})

# Posterior probabilities
PP_sBYM <- sapply(sBYM.model$marginals.random$ID_area[1:70], function(x) {
  1 - inla.pmarginal(0, x)
})
```
```{r}
## 2.6 Obtain the posterior estimates from the spatial model to be plotted, that is (i) the area level posterior mean of the residual RRs and (ii) the posterior probability (PP) that the residual RRs > 1.

# Combine IRR and PP results
resRR_PP <- data.frame(
  RR = RR_sBYM,
  PP = PP_sBYM,
  ID_area = RESP_DATAagg$ID_area
)
```
```{r}
## 2.7 plot(density(resRR_PP$RR))
resRR_PP$RRcat = cut(resRR_PP$RR,
                     breaks = c(min(resRR_PP$RR),
                                0.4, 0.6, 0.8, 1, 1.2, 1.4, 1.6, 1.8, 2.0,
                                max(resRR_PP$RR)),
                     include.lowest = TRUE)

# breakpoints
resRR_PP$PPcat = cut(resRR_PP$PP, c(0, 0.2, 0.8, 1.00), include.lowest = TRUE)
```
```{r}
## 2.8 Using ggplot2 package, produce a map of the posterior mean of the residual RRs and the posterior probabilities that the residual RRs are > 1

# join sf object and data frame with the posterior estimates
map_result <- left_join(carto_up_sf, resRR_PP, by = "ID_area")

# 地图1：相对风险（RR）分布图
p1 = ggplot() + geom_sf(data = map_result) + aes(fill = RRcat) +
  theme_bw() + scale_fill_brewer(palette = "PuOr") + 
  guides(fill=guide_legend(title="RR")) + ggtitle("RR Spatial model") + 
  theme(text = element_text(size=15), 
                  axis.text.x = element_blank(), 
                  axis.text.y = element_blank(), plot.title = element_text(size = 12, face = "bold"))

# 地图2：后验概率 > 1 的区域（PP）
p2 = ggplot() + geom_sf(data = map_result) + aes(fill = PPcat) +
  theme_bw() +
  scale_fill_viridis(
    option = "plasma", name="PP",
    discrete = T,
    direction = -1,
    guide = guide_legend(
      title.position = 'top',
      reverse = T
    )) +  ggtitle("PP Spatial model") + theme(text = element_text(size=15), 
                  axis.text.x = element_blank(), 
                  axis.text.y = element_blank(), plot.title = element_text(size = 12, face = "bold")) 

p1|p2
```

```{r}
###---------------------------- 3. Estimate the spatial fraction-----------------------------------------
sBYM.model$summary.hyperpar
```
```{r}
###------------------------- 4. Spatio-temporal model (no interaction)----------------------------------------
## 4.1 Prepare the data
#Join the data with the shapefile so the order of the shapefile is maintained.  

# Rename the columns of Observed and Expected as before
RESP_DATA_ST <- data %>% rename(O = rape, E = e_rape)

# 4.2 Run the model in INLA
formula_ST_noint <- O ~ 
  f(ID_area, model = "bym2", graph = UP.ad,
    scale.model = TRUE,
    hyper = list(prec = list(
                            prior = "pc.prec",
                            param = c(0.5 / 0.31, 0.01)),
                            phi = list(
                            prior = "pc",
                            param = c(0.5, 2 / 3)))) + f(ID_year,model="rw1", hyper=list(prec = list(
                            prior = "pc.prec",
                            param = c(0.5 / 0.31, 0.01))
                            
  ))

stBYM.model <- inla(
  formula = formula_ST_noint,
  family = "poisson",
  data = RESP_DATA_ST,
  E = E,
  control.compute = list(waic = TRUE)
)
```
```{r}
## 4.3 Create the posterior mean for the spatial and temporal effects
# Spatial RR and PP
RR_stBYM <- sapply(1:70, function(i) {
  inla.emarginal(function(x) exp(x), stBYM.model$marginals.random$ID_area[[i]])
})
PP_stBYM <- sapply(stBYM.model$marginals.random$ID_area[1:70], function(x) {
  1 - inla.pmarginal(0, x)
})

# Temporal RR + CI
RR_stRW_RR <- c()
RR_stRW_lo <- c()
RR_stRW_hi <- c()

for (i in 1:14) {  # 2001-2014
  #Posterior mean
  RR_stRW_RR[i] <- inla.emarginal(function(x) exp(x), stBYM.model$marginals.random$ID_year[[i]])
  #2.5% quantile 
  RR_stRW_lo[i] <- inla.qmarginal(0.025, inla.tmarginal(function(x) exp(x), stBYM.model$marginals.random$ID_year[[i]]))
  #97.5% quantile 
  RR_stRW_hi[i] <- inla.qmarginal(0.975, inla.tmarginal(function(x) exp(x), stBYM.model$marginals.random$ID_year[[i]]))
}

RR_stRW = data.frame(RR=RR_stRW_RR,low=RR_stRW_lo,high=RR_stRW_hi)

```
```{r}
## 4.4 Plot the temporal residual RRs (RR_stWR) with CI
ggplot(RR_stRW, aes(seq(2001,2014), RR)) + geom_line() + ggtitle("ST model (Rape) - Temporal Trend") +
  geom_ribbon(aes(ymin=low, ymax=high), alpha = 0.2) + ylab("Relative Risk") + xlab("Year") 
```
```{r}
## 4.5 Map the spatial residual RRs (RR_stBYM)
resRR_PP_st <- data.frame(RR = RR_stBYM, PP = PP_stBYM,ID_area = 1:70)

# breakpoints
resRR_PP_st$RRcat <- cut(resRR_PP_st$RR, 
                         breaks = c(min(resRR_PP_st$RR), 0.4, 0.6, 0.8, 1, 1.2, 1.4, 1.6, 1.8, 2.0,               
                                    max(resRR_PP_st$RR)),include.lowest = TRUE)

resRR_PP_st$PPcat <- cut(resRR_PP_st$PP, breaks = c(0, 0.2, 0.8, 1.00), include.lowest = TRUE)

# combine
map_RR_ST <- left_join(st_as_sf(carto_up), resRR_PP_st, by = "ID_area")
```
```{r}
# Plot
p3 = ggplot() + geom_sf(data = map_RR_ST) + aes(fill = RRcat) +
  theme_bw() + scale_fill_brewer(palette = "PuOr") + 
  guides(fill=guide_legend(title="RR")) +  ggtitle("RR ST model") +
  theme(text = element_text(size=15), 
        axis.text.x = element_blank(), 
        axis.text.y = element_blank(), plot.title = element_text(size = 12, face = "bold")) 

p4 = ggplot() + geom_sf(data = map_RR_ST) + aes(fill = PPcat) +
  theme_bw() +
  scale_fill_viridis(
    option = "plasma",
    name = "PP ST model",
    discrete = T,
    direction = -1,
    guide = guide_legend(
      title.position = 'top',
      reverse = T
    )) +  ggtitle("PP ST model") + theme(text = element_text(size=15), 
        axis.text.x = element_blank(), 
        axis.text.y = element_blank(), plot.title = element_text(size = 12, face = "bold"))

(p1|p2) / (p3|p4)

p5 <- ggplot(map_RR_ST) +
  geom_sf(aes(fill = RRcat)) +
  scale_fill_brewer(palette = "YlOrRd") +
  ggtitle("RR from Spatio-Temporal Model") +
  theme_minimal()

p5
```
```{r}
dat.WAIC = data.frame(model = c("Spatial", "SpatTemp no int"), 
                       WAIC = round(c(sBYM.model$waic$waic, stBYM.model$waic$waic))
)

row.names(dat.WAIC) = NULL

knitr::kable(dat.WAIC, caption = "WAIC of the fifferent models") %>%  kable_styling(bootstrap_options = "striped", full_width = F, position = "center")
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
summary(cars)
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
