# EDA Visualisation
This would include:

- Table 1
- Temporal trends for both crimes (do both SMR & crude rates)
- SMR / crude rates for both crimes (do both SMR & crude rates)
- Temporal trends per region with average (in appendix. !!! This is to justify model selection)

### overall prep

```{r eval=TRUE, echo=FALSE}
# Load the libraries you will use for the mini-project report
library(dplyr)        # A package for data manipulation
library(sf)           # Simple feature for R
library(spdep)        # Functions and tests for evaluating spatial patterns 
library(tidyr)        # Tools to create tidy data
library(INLA)         # Integrated Nested Laplace Approximation package
library(ggplot2)      # A package for creating maps and graphs
library(viridis)      # A package providing color palettes 
library(patchwork)    # A package to compose plots

# For tables in RMarkdown
library(knitr)
library(kableExtra)
load("../CrimeUttarPradesh.RData")
```

### Temporal trends visualisation - SMR & crude rates

```{r}

# Calculate crude rates per 100,000 women
data$rape_rate_per100k <- data$rape / data$pop * 100000
data$dowry_rate_per100k <- data$dowry/ data$pop * 100000

# Create data aggregated across time (i.e. collapsed across space)

year_agg <- data %>% group_by(year) %>% summarise(rape_obs = sum(rape),
                                                  rape_exp = sum(e_rape),
                                                  dowry_obs = sum(dowry),
                                                  dowry_exp = sum(e_dowry),
                                                  total_pop = sum(pop),
                                                  SMR_rape = sum(rape)/sum(e_rape),
                                                  SMR_dowry = sum(dowry)/sum(e_dowry),
                                                  rape_crude_rate = rape_obs / total_pop * 100000,
                                                  dowry_crude_rate = dowry_obs / total_pop * 100000,
                                                  max_rape_region = dist[which.max(rape_rate_per100k)],
                                                  max_rape_rate = max(rape_rate_per100k),
                                                  min_rape_region = dist[which.min(rape_rate_per100k)],
                                                  min_rape_rate = min(rape_rate_per100k),
                                                  max_dowry_region = dist[which.max(dowry_rate_per100k)],
                                                  max_dowry_rate = max(dowry_rate_per100k),
                                                  min_dowry_region = dist[which.min(dowry_rate_per100k)],
                                                  min_dowry_rate = min(dowry_rate_per100k))


# Visualise temporal trends of SMRs

ggplot(year_agg, aes(x = year)) +
  geom_line(aes(y=SMR_rape, color = "Rape")) + 
  geom_line(aes(y=SMR_dowry, color = "Dowry")) + theme_minimal() +
  labs(title = "Temporal evolution of SMRs of Rape and Dowry Crime", 
       x = "Year", y = "Crude Rate", color = "Crime Type")

# Visualise temporal trends of crude rates 

ggplot(year_agg, aes(x = year)) +
  geom_line(aes(y=rape_crude_rate, color = "Rape")) + 
  geom_line(aes(y=dowry_crude_rate, color = "Dowry")) + theme_minimal() +
  labs(title = "Temporal evolution of crude rates (per 100,000) of Rape and Dowry Crime", 
       x = "Year", y = "Crude Rate", color = "Crime Type")

```
### Temporal trends visualisation per region
```{r, fig.width=12, fig.height=4}

color_map <- c(
  "Dowry: State Average" = "#8E44AD",
  "Rape: State Average" = "#21918C",
  "Individual Districts" = "lightgray"
)
dummy_df <- data.frame(
  x = mean(range(data$year)), 
  y = mean(c(data$dowry_rate_per100k, year_agg$dowry_crude_rate), na.rm = TRUE)
)

p_dowry <- ggplot() + 
  geom_line(data=data, aes(x=year, y=dowry_rate_per100k, group=ID_area), color = "lightgray", alpha=0.7, show.legend = FALSE) +
  geom_line(data=year_agg, aes(x=year, y=dowry_crude_rate, color = "Dowry: State Average"), size = 1.5) + 
  
  # some dummy lines below for arrangment of legends
  geom_line(data = dummy_df, # dummy space for legend
            aes(x = x, y = y, color = "Individual Districts"), size = 1, alpha = 0.6, show.legend = TRUE) +
  geom_line(data = dummy_df, aes(x = x, y = y, color = "Rape: State Average"), size = 1, alpha = 0, show.legend = TRUE) +
  
  scale_color_manual(name = "Legend", values = color_map) +
  theme(legend.position = "right") +
  labs( y = "Crude Rate of Dowry Crime", x = "Year") + 
  theme_minimal()

p_rape <- ggplot() + 
  geom_line(data=data, aes(x=year, y=rape_rate_per100k, group=ID_area), color = "lightgray", alpha=0.7, show.legend = FALSE) +
  geom_line(data=year_agg, aes(x=year, y=rape_crude_rate, color = "Rape: State Average"), size = 1.5) + 
  
  # Dummy lines 
  geom_line(data = dummy_df, # dummy space for legend
            aes(x = x, y = y, color = "Individual Districts"), size = 1, alpha = 0.6, show.legend = TRUE) +
  geom_line(data = dummy_df, aes(x = x, y = y, color = "Dowry: State Average"), size = 1, alpha = 0, show.legend = TRUE) +
  
  scale_color_manual(name = "Legend", values = color_map) +
  theme(legend.position = "right") +
  labs(y = "Crude Rate of Rape", x = "Year") + 
  theme_minimal()

(p_dowry | p_rape) +
  plot_layout(guides = "collect") +
  plot_annotation(title = "Crude Rates of Rape and Dowry Crime in Uttar Pradesh (2001–2014)")

```
### Map visualisation of SMRs & crude rates

```{r}
# Aggregate data across space

dist_rates <- data %>%
  group_by(ID_area) %>%
  summarise(
    rape_obs = sum(rape),
    rape_exp = sum(e_rape),
    dowry_obs = sum(dowry),
    dowry_exp = sum(e_dowry),
    total_pop = sum(pop),
    SMR_rape = sum(rape)/sum(e_rape),
    SMR_dowry = sum(dowry)/sum(e_dowry),
    rape_crude_rate = rape_obs / total_pop * 100000,
    dowry_crude_rate = dowry_obs / total_pop * 100000,)

map_rates <- left_join(carto_up, dist_rates, by = c("ID_area" = "ID_area"))

map_rates_long_SMR <- map_rates %>% # Making long-format data for RRs
  select(ID_area, geometry, SMR_rape, SMR_dowry) %>%
  pivot_longer(cols = c(SMR_rape, SMR_dowry), names_to = "CrimeType", values_to = "SMR") %>%
  mutate(CrimeType = recode(CrimeType, rape_rate = "Rape",dowry_rate = "Dowry")
  )

map_rates_long_rate <- map_rates %>% # Making long-format data for rates
  select(ID_area, geometry, rape_crude_rate, dowry_crude_rate) %>%
  pivot_longer(cols = c(rape_crude_rate, dowry_crude_rate), names_to = "CrimeType", values_to = "Rate") %>%
  mutate(CrimeType = recode(CrimeType, rape_rate = "Rape",dowry_rate = "Dowry")
  )

# Plot SMR
ggplot(map_rates_long_SMR) +
  geom_sf(aes(fill = SMR), color = NA) +
  scale_fill_viridis_c(
    name = "SMR",
    labels = label_comma(accuracy = 1)) +
  facet_wrap(~ CrimeType) + # set ncol=1 argument if want top and bottom
  labs(title = "SMRs by District (2001–2014)") + theme_bw()

# Plot crude rate
ggplot(map_rates_long_rate) +
  geom_sf(aes(fill = Rate), color = NA) +
  geom_sf_text(data = carto_up, aes(label = ID_area), size = 2, color = "white") +
  scale_fill_viridis_c(
    name = "Crude Rate\n(per 100,000)",
    labels = label_comma(accuracy = 1)) +
  facet_wrap(~ CrimeType) + # set ncol=1 argument if want top and bottom
  labs(title = "Crude Rates by District (2001–2014)") + theme_bw()

```
### Map visualisation of unsmoothed SMRs for comparison with smoothed 

```{r}
dist_rates <- data %>%
  group_by(ID_area) %>%
  summarise(
    rape_obs = sum(rape),
    rape_exp = sum(e_rape),
    dowry_obs = sum(dowry),
    dowry_exp = sum(e_dowry),
    total_pop = sum(pop),
    SMR_rape = sum(rape)/sum(e_rape),
    SMR_dowry = sum(dowry)/sum(e_dowry),
    rape_crude_rate = rape_obs / total_pop * 100000,
    dowry_crude_rate = dowry_obs / total_pop * 100000,)


# dowry
breaks_d = c(min(dist_rates$SMR_dowry), 0.6, 0.8, 1, 1.2, 1.4, 1.6, 1.8, 2, max(dist_rates$SMR_dowry))
breaks_r = c(min(dist_rates$SMR_rape), 0.4, 0.6, 0.8, 1, 1.2, 1.4, 1.6, 1.8, 2, max(dist_rates$SMR_rape))

dist_rates$SMR_dowry_cat = cut(dist_rates$SMR_dowry, breaks=breaks_d, include.lowest = TRUE)
dist_rates$SMR_rape_cat = cut(dist_rates$SMR_rape, breaks=breaks_r, include.lowest = TRUE)

map_s_RR=left_join(carto_up, dist_rates, by=c("ID_area"="ID_area"))


dowry_SMR = ggplot() + geom_sf(data=map_s_RR) + aes(fill=SMR_dowry_cat) + theme_bw() +
  scale_fill_brewer(palette = "PuOr") + guides(fill=guide_legend(title="RR")) + ggtitle("Unsmoothed SMRs") +
    theme(text = element_text(size=15), 
                  axis.text.x = element_blank(), 
                  axis.text.y = element_blank(), plot.title = element_text(size = 12, face = "bold"))

rape_SMR = ggplot() + geom_sf(data=map_s_RR) + aes(fill=SMR_rape_cat) + theme_bw() +
  scale_fill_brewer(palette = "PuOr") + guides(fill=guide_legend(title="RR")) + ggtitle("Unsmoothed SMRs") +
    theme(text = element_text(size=15), 
                  axis.text.x = element_blank(), 
                  axis.text.y = element_blank(), plot.title = element_text(size = 12, face = "bold"))

dowry_SMR | rape_SMR
```


### summary stats of regions per each year 

```{r}
# Visualise summary stats - crude rates

year_agg_vis <- year_agg %>% mutate(
  'Year' = year,
  'Rape' = round(rape_crude_rate, 1),
  'Dowry' = round(dowry_crude_rate, 1),
  'Higest Rape' = paste0(max_rape_region, " (", round(max_rape_rate, 1), ")"),
  'Lowest Rape' = paste0(min_rape_region, " (", round(min_rape_rate, 1), ")"),
  'Highest Dowry'= paste0(max_dowry_region, " (", round(max_dowry_rate, 1), ")"),
  'Lowest Dowry' = paste0(min_rape_region, " (", round(min_dowry_rate, 1), ")") ) %>% 
  select( 'Year', 'Rape', 'Dowry', 'Higest Rape', 'Lowest Rape', 'Highest Dowry', 'Lowest Dowry')

reg_table <- knitr::kable(year_agg_vis, caption = "Yearly summary of crude crime rates (per 100,000 women)") %>%
  kable_styling(bootstrap_options = "striped", full_width = F, position = "center")
reg_table
```

# Modelling:

### Spatial model - dowry

```{r, fig.width=12, fig.height=6}

# create dataset collaped across time
up_agg <- data %>% group_by(ID_area) %>% # aggregate over areas 
  summarise(O = sum(dowry), E = sum(e_dowry)) %>% mutate(SMR=O/E) # compute SMRs per area

# fit hierarchical poisson log-linear model
ID <- seq(1,70)
f_BYM2 <- O ~ f(ID, model="bym2", graph=adj,
                      hyper=list(
                        prec=list(prior = "pc.prec", param = c(0.5 / 0.31, 0.01)),
                        phi=list(prior="pc", param=c(0.5,2/3))))

s_dowry_model = inla(formula=f_BYM2, family="poisson", data=up_agg, E=E, 
               control.predictor = list(compute=TRUE), 
               control.compute = list(waic=TRUE))


# obtain posterior RRs

RR_s <- c()
for(i in 1:70) {RR_s[i] <- inla.emarginal(function(x) exp(x), s_dowry_model$marginals.random$ID[[i]])}

# Posterior probabilities

RR_s_marg <- s_dowry_model$marginals.random$ID[1:70]
PP_s <- lapply(RR_s_marg, function(x) {1-inla.pmarginal(0,x)})

s_RR_PP <- data.frame(resRR=RR_s, PP=unlist(PP_s), SP_ID=up_agg[,1])

# Plot 

breaks = c(min(s_RR_PP$resRR), 0.6, 0.8, 1, 1.2, 1.4, 1.6, 1.8, 2, max(s_RR_PP$resRR))
s_RR_PP$resRR_cat = cut(s_RR_PP$resRR, breaks=breaks, include.lowest = TRUE)
breaks_pp = c(0, 0.2, 0.8, 1.00)
s_RR_PP$PP_cat = cut(s_RR_PP$PP, breaks_pp, include.lowest = TRUE)
map_s_RR_PP=left_join(carto_up, s_RR_PP, by=c("ID_area"="ID_area"))

dowry_RR_s = ggplot() + geom_sf(data=map_s_RR_PP) + aes(fill=resRR_cat) + theme_bw() +
  scale_fill_brewer(palette = "PuOr") + guides(fill=guide_legend(title="RR")) + ggtitle("RR Spatial model") +
    theme(text = element_text(size=15), 
                  axis.text.x = element_blank(), 
                  axis.text.y = element_blank(), plot.title = element_text(size = 12, face = "bold"))

dowry_PP_s = ggplot() + geom_sf(data=map_s_RR_PP) + aes(fill=PP_cat) + theme_bw() +
    scale_fill_viridis(
    option = "plasma", name="PP",
    discrete = T,
    direction = -1,
    guide = guide_legend(
      title.position = 'top',
      reverse = T
    )) +  ggtitle("PP Spatial model") + theme(text = element_text(size=15), 
                  axis.text.x = element_blank(), 
                  axis.text.y = element_blank(), plot.title = element_text(size = 12, face = "bold")) 
```

### Spatial model - rape 

```{r, fig.width=12, fig.height=6}

# create dataset collaped across time
up_agg_rape <- data %>% group_by(ID_area) %>% # aggregate over areas 
  summarise(O = sum(rape), E = sum(e_rape)) %>% mutate(SMR=O/E) # compute SMRs per area

# fit hierarchical poisson log-linear model
ID <- seq(1,70)
f_BYM2 <- O ~ f(ID, model="bym2", graph=adj,
                      hyper=list(
                        prec=list(prior = "pc.prec", param = c(0.5 / 0.31, 0.01)),
                        phi=list(prior="pc", param=c(0.5,2/3))))

s_rape_model = inla(formula=f_BYM2, family="poisson", data=up_agg_rape, E=E, 
               control.predictor = list(compute=TRUE), 
               control.compute = list(waic=TRUE))


# obtain posterior RRs

RR_s <- c()
for(i in 1:70) {RR_s[i] <- inla.emarginal(function(x) exp(x), s_rape_model$marginals.random$ID[[i]])}

# Posterior probabilities

RR_s_marg <- s_rape_model$marginals.random$ID[1:70]
PP_s <- lapply(RR_s_marg, function(x) {1-inla.pmarginal(0,x)})

s_RR_PP <- data.frame(resRR=RR_s, PP=unlist(PP_s), SP_ID=up_agg[,1])

# Plot 

breaks = c(min(s_RR_PP$resRR), 0.4, 0.6, 0.8, 1, 1.2, 1.4, 1.6, 1.8, 2, max(s_RR_PP$resRR))
s_RR_PP$resRR_cat = cut(s_RR_PP$resRR, breaks=breaks, include.lowest = TRUE)
breaks_pp = c(0, 0.2, 0.8, 1.00)
s_RR_PP$PP_cat = cut(s_RR_PP$PP, breaks_pp, include.lowest = TRUE)
map_s_RR_PP=left_join(carto_up, s_RR_PP, by=c("ID_area"="ID_area"))

rape_RR_s = ggplot() + geom_sf(data=map_s_RR_PP) + aes(fill=resRR_cat) + theme_bw() +
  scale_fill_brewer(palette = "PuOr") + guides(fill=guide_legend(title="RR")) + ggtitle("RR Spatial model") +
    theme(text = element_text(size=15), 
                  axis.text.x = element_blank(), 
                  axis.text.y = element_blank(), plot.title = element_text(size = 12, face = "bold"))

rape_PP_s = ggplot() + geom_sf(data=map_s_RR_PP) + aes(fill=PP_cat) + theme_bw() +
    scale_fill_viridis(
    option = "plasma", name="PP",
    discrete = T,
    direction = -1,
    guide = guide_legend(
      title.position = 'top',
      reverse = T
    )) +  ggtitle("PP Spatial model") + theme(text = element_text(size=15), 
                  axis.text.x = element_blank(), 
                  axis.text.y = element_blank(), plot.title = element_text(size = 12, face = "bold")) 

```

### ST model - dowry 

```{r}
# Prep data 
data_st_dowry = left_join(carto_up, data, by = "ID_area")
data_st_dowry = data_st_dowry %>% dplyr::rename(O=dowry, E=e_dowry)

# Define & fit the model

formula_st_dowry = O ~ f(ID_area, model="bym2", graph=adj, hyper=list(
                        prec=list(prior = "pc.prec", param = c(0.5 / 0.31, 0.01)),
                        phi=list(prior="pc", param=c(0.5,2/3))
                      )) + 
  f(ID_year, model="rw1", hyper=list(prec=list(prior="pc.prec", param=c(0.5/0.31, 0.01))))

st_dowry_model = inla(formula=formula_st_dowry, family="poisson", data=data_st_dowry, E=E, control.compute=list(waic=TRUE), 
                control.predictor = list(compute=TRUE))

RR_stRW_RR = c()
RR_stRW_l = c()
RR_stRW_h = c()

for(i in 1:14) {
  RR_stRW_RR[i] = inla.emarginal(function(x) exp(x), st_dowry_model$marginals.random$ID_year[[i]])
  RR_stRW_l[i] = inla.qmarginal(0.025,inla.tmarginal(function(x) exp(x), st_dowry_model$marginals.random$ID_year[[i]]))
  RR_stRW_h[i] = inla.qmarginal(0.975,inla.tmarginal(function(x) exp(x), st_dowry_model$marginals.random$ID_year[[i]]))
}

RR_stRW_dowry = data.frame(RR=RR_stRW_RR, low_CI=RR_stRW_l, up_CI = RR_stRW_h)

# Plot temporal residual RRs

# temp1 = ggplot(RR_stRW_dowry, aes(seq(2001,2014), RR)) + geom_line() + ggtitle("ST model (no interactions)") + theme_bw() +
#   geom_ribbon(aes(ymin=low_CI,ymax=up_CI), alpha=0.2) + labs(x="year")

# Plot spatial residual RRs

RR_stBYM = c()
for(i in 1:70) {RR_stBYM[i] = inla.emarginal(function(x) exp(x), st_dowry_model$marginals.random$ID_area[[i]])} ##
RR_stBYM_marg = st_dowry_model$marginals.random$ID_area[1:70]
PP_stBYM = lapply(RR_stBYM_marg, function(x) {1-inla.pmarginal(0,x)})

resRR_PP_st = data.frame(RR=RR_stBYM, PP=unlist(PP_stBYM), ID_area=carto_up$ID_area)

# plot 
breaks = c(min(resRR_PP_st$RR), 0.6, 0.8, 1, 1.2, 1.4, 1.6, 1.8, 2, max(resRR_PP_st$RR))
resRR_PP_st$RR_cat = cut(resRR_PP_st$RR, breaks=breaks, include.lowest = TRUE)
breaks_pp = c(0, 0.2, 0.8, 1.00)
resRR_PP_st$PP_cat = cut(resRR_PP_st$PP, breaks_pp, include.lowest = TRUE)
map_st_RR_PP=left_join(carto_up, resRR_PP_st, by=c("ID_area"="ID_area"))

dowry_RR_st = ggplot() + geom_sf(data=map_st_RR_PP) + aes(fill=RR_cat) + theme_bw() +
  scale_fill_brewer(palette = "PuOr") + guides(fill=guide_legend(title="RR")) + ggtitle("RR Spatio-temporal model") +
    theme(text = element_text(size=15), 
                  axis.text.x = element_blank(), 
                  axis.text.y = element_blank(), plot.title = element_text(size = 12, face = "bold"))

dowry_PP_st = ggplot() + geom_sf(data=map_st_RR_PP) + aes(fill=PP_cat) + theme_bw() +
    scale_fill_viridis(
    option = "plasma", name="PP",
    discrete = T,
    direction = -1,
    guide = guide_legend(
      title.position = 'top',
      reverse = T
    )) +  ggtitle("PP Spatio-temporal model") + theme(text = element_text(size=15), 
                  axis.text.x = element_blank(), 
                  axis.text.y = element_blank(), plot.title = element_text(size = 12, face = "bold")) 

```


### ST model - rape 

```{r}
# Prep data 
data_st_rape = left_join(carto_up, data, by = "ID_area")
data_st_rape = data_st_rape %>% dplyr::rename(O=rape, E=e_rape)

# Define & fit the model

formula_st_rape = O ~ f(ID_area, model="bym2", graph=adj, hyper=list(
                        prec=list(prior = "pc.prec", param = c(0.5 / 0.31, 0.01)),
                        phi=list(prior="pc", param=c(0.5,2/3))
                      )) + 
  f(ID_year, model="rw1", hyper=list(prec=list(prior="pc.prec", param=c(0.5/0.31, 0.01))))

st_rape_model = inla(formula=formula_st_rape, family="poisson", data=data_st_rape, E=E, control.compute=list(waic=TRUE), 
                control.predictor = list(compute=TRUE))

RR_stRW_RR = c()
RR_stRW_l = c()
RR_stRW_h = c()

for(i in 1:14) {
  RR_stRW_RR[i] = inla.emarginal(function(x) exp(x), st_rape_model$marginals.random$ID_year[[i]])
  RR_stRW_l[i] = inla.qmarginal(0.025,inla.tmarginal(function(x) exp(x), st_rape_model$marginals.random$ID_year[[i]]))
  RR_stRW_h[i] = inla.qmarginal(0.975,inla.tmarginal(function(x) exp(x), st_rape_model$marginals.random$ID_year[[i]]))
}

RR_stRW_rape = data.frame(RR=RR_stRW_RR, low_CI=RR_stRW_l, up_CI = RR_stRW_h)

# Plot temporal residual RRs

# temp1 = ggplot(RR_stRW_dowry, aes(seq(2001,2014), RR)) + geom_line() + ggtitle("ST model (no interactions)") + theme_bw() +
#   geom_ribbon(aes(ymin=low_CI,ymax=up_CI), alpha=0.2) + labs(x="year")

# Plot spatial residual RRs

RR_stBYM = c()
for(i in 1:70) {RR_stBYM[i] = inla.emarginal(function(x) exp(x), st_rape_model$marginals.random$ID_area[[i]])} ##
RR_stBYM_marg = st_rape_model$marginals.random$ID_area[1:70]
PP_stBYM = lapply(RR_stBYM_marg, function(x) {1-inla.pmarginal(0,x)})

resRR_PP_st = data.frame(RR=RR_stBYM, PP=unlist(PP_stBYM), ID_area=carto_up$ID_area)

# plot 
breaks = c(min(resRR_PP_st$RR), 0.4, 0.6, 0.8, 1, 1.2, 1.4, 1.6, 1.8, 2, max(resRR_PP_st$RR))
resRR_PP_st$RR_cat = cut(resRR_PP_st$RR, breaks=breaks, include.lowest = TRUE)
breaks_pp = c(0, 0.2, 0.8, 1.00)
resRR_PP_st$PP_cat = cut(resRR_PP_st$PP, breaks_pp, include.lowest = TRUE)
map_st_RR_PP=left_join(carto_up, resRR_PP_st, by=c("ID_area"="ID_area"))

rape_RR_st = ggplot() + geom_sf(data=map_st_RR_PP) + aes(fill=RR_cat) + theme_bw() +
  scale_fill_brewer(palette = "PuOr") + guides(fill=guide_legend(title="RR")) + ggtitle("RR Spatio-temporal model") +
    theme(text = element_text(size=15), 
                  axis.text.x = element_blank(), 
                  axis.text.y = element_blank(), plot.title = element_text(size = 12, face = "bold"))

rape_PP_st = ggplot() + geom_sf(data=map_st_RR_PP) + aes(fill=PP_cat) + theme_bw() +
    scale_fill_viridis(
    option = "plasma", name="PP",
    discrete = T,
    direction = -1,
    guide = guide_legend(
      title.position = 'top',
      reverse = T
    )) +  ggtitle("PP Spatio-temporal model") + theme(text = element_text(size=15), 
                  axis.text.x = element_blank(), 
                  axis.text.y = element_blank(), plot.title = element_text(size = 12, face = "bold")) 

```


### Spatio-temporal model with Interaction I - dowry

```{r}

formula_stInt_dowry = O ~ f(ID_area, model="bym2", graph=adj, hyper=list(
                        prec=list(prior = "pc.prec", param = c(0.5 / 0.31, 0.01)),
                        phi=list(prior="pc", param=c(0.5,2/3))
                      )) + 
  f(ID_year, model="rw1", hyper=list(prec=list(prior="pc.prec", param=c(0.5/0.31, 0.01)))) + 
  f(ID_area_year, model="iid", hyper=list(prec=list(prior="pc.prec", param = c(0.5/0.31, 0.01))))

st_int_model_dowry = inla(formula = formula_stInt_dowry, family="poisson", data=data_st_dowry, E=E, 
                    control.compute=list(dic=TRUE, waic=TRUE))

# temporal RRs & CIs

RR_stInt_RW_RR = c()
RR_stInt_RW_l = c()
RR_stInt_RW_h = c()

for(i in 1:14) {
  RR_stInt_RW_RR[i] = inla.emarginal(function(x) exp(x), st_int_model_dowry$marginals.random$ID_year[[i]])
  RR_stInt_RW_l[i] = inla.qmarginal(0.025,inla.tmarginal(function(x) exp(x), st_int_model_dowry$marginals.random$ID_year[[i]]))
  RR_stInt_RW_h[i] = inla.qmarginal(0.975,inla.tmarginal(function(x) exp(x), st_int_model_dowry$marginals.random$ID_year[[i]]))
}

RR_stInt_RW_dowry = data.frame(RR=RR_stInt_RW_RR, low_CI=RR_stInt_RW_l, up_CI = RR_stInt_RW_h)

# spatial RRs

RR_stInt_BYM = c()
for(i in 1:70) {RR_stInt_BYM[i] = inla.emarginal(function(x) exp(x), 
                                                  st_int_model_dowry$marginals.random$ID_area[[i]])} 
RR_stInt_BYM_marg = st_int_model_dowry$marginals.random$ID_area[1:70]
PP_stInt_BYM = lapply(RR_stInt_BYM_marg, function(x) {1-inla.pmarginal(0,x)})

# paste

resRR_PP_stInt = data.frame(RR=RR_stInt_BYM, PP=unlist(PP_stInt_BYM), ID_area=carto_up$ID_area)

# plot 
breaks = c(min(resRR_PP_stInt$RR), 0.6, 0.8, 1, 1.2, 1.4, 1.6, 1.8, 2, max(resRR_PP_stInt$RR))
resRR_PP_stInt$RR_cat = cut(resRR_PP_stInt$RR, breaks=breaks, include.lowest = TRUE)
breaks_pp = c(0, 0.2, 0.8, 1.00)
resRR_PP_stInt$PP_cat = cut(resRR_PP_stInt$PP, breaks_pp, include.lowest = TRUE)
map_stInt_RR_PP=left_join(carto_up, resRR_PP_stInt, by=c("ID_area"="ID_area"))

dowry_RR_stInt = ggplot() + geom_sf(data=map_stInt_RR_PP) + aes(fill=RR_cat) + theme_bw() +
  scale_fill_brewer(palette = "PuOr") + guides(fill=guide_legend(title="RR")) + ggtitle("RR Spatio-temporal model with Interaction I") +
    theme(text = element_text(size=15), 
                  axis.text.x = element_blank(), 
                  axis.text.y = element_blank(), plot.title = element_text(size = 12, face = "bold"))

dowry_PP_stInt = ggplot() + geom_sf(data=map_stInt_RR_PP) + aes(fill=PP_cat) + theme_bw() +
    scale_fill_viridis(
    option = "plasma", name="PP",
    discrete = T,
    direction = -1,
    guide = guide_legend(
      title.position = 'top',
      reverse = T
    )) +  ggtitle("PP Spatio-temporal model with Interaction I") + theme(text = element_text(size=15), 
                  axis.text.x = element_blank(), 
                  axis.text.y = element_blank(), plot.title = element_text(size = 12, face = "bold")) 


```


### Spatio-temporal model with Interaction I - rape

```{r}

formula_stInt_rape = O ~ f(ID_area, model="bym2", graph=adj, hyper=list(
                        prec=list(prior = "pc.prec", param = c(0.5 / 0.31, 0.01)),
                        phi=list(prior="pc", param=c(0.5,2/3))
                      )) + 
  f(ID_year, model="rw1", hyper=list(prec=list(prior="pc.prec", param=c(0.5/0.31, 0.01)))) + 
  f(ID_area_year, model="iid", hyper=list(prec=list(prior="pc.prec", param = c(0.5/0.31, 0.01))))

st_int_model_rape = inla(formula = formula_stInt_rape, family="poisson", data=data_st_rape, E=E, 
                    control.compute=list(dic=TRUE, waic=TRUE))

# temporal RRs & CIs

RR_stInt_RW_RR = c()
RR_stInt_RW_l = c()
RR_stInt_RW_h = c()

for(i in 1:14) {
  RR_stInt_RW_RR[i] = inla.emarginal(function(x) exp(x), st_int_model_rape$marginals.random$ID_year[[i]])
  RR_stInt_RW_l[i] = inla.qmarginal(0.025,inla.tmarginal(function(x) exp(x), st_int_model_rape$marginals.random$ID_year[[i]]))
  RR_stInt_RW_h[i] = inla.qmarginal(0.975,inla.tmarginal(function(x) exp(x), st_int_model_rape$marginals.random$ID_year[[i]]))
}

RR_stInt_RW_rape = data.frame(RR=RR_stInt_RW_RR, low_CI=RR_stInt_RW_l, up_CI = RR_stInt_RW_h)

# spatial RRs

RR_stInt_BYM = c()
for(i in 1:70) {RR_stInt_BYM[i] = inla.emarginal(function(x) exp(x), 
                                                  st_int_model_rape$marginals.random$ID_area[[i]])} 
RR_stInt_BYM_marg = st_int_model_rape$marginals.random$ID_area[1:70]
PP_stInt_BYM = lapply(RR_stInt_BYM_marg, function(x) {1-inla.pmarginal(0,x)})

# paste

resRR_PP_stInt = data.frame(RR=RR_stInt_BYM, PP=unlist(PP_stInt_BYM), ID_area=carto_up$ID_area)


breaks = c(min(resRR_PP_stInt$RR), 0.4, 0.6, 0.8, 1, 1.2, 1.4, 1.6, 1.8, 2, max(resRR_PP_stInt$RR))
resRR_PP_stInt$RR_cat = cut(resRR_PP_stInt$RR, breaks=breaks, include.lowest = TRUE)
breaks_pp = c(0, 0.2, 0.8, 1.00)
resRR_PP_stInt$PP_cat = cut(resRR_PP_stInt$PP, breaks_pp, include.lowest = TRUE)
map_stInt_RR_PP=left_join(carto_up, resRR_PP_stInt, by=c("ID_area"="ID_area"))

rape_RR_stInt = ggplot() + geom_sf(data=map_stInt_RR_PP) + aes(fill=RR_cat) + theme_bw() +
  scale_fill_brewer(palette = "PuOr") + guides(fill=guide_legend(title="RR")) + ggtitle("RR Spatio-temporal model with Interaction I") +
    theme(text = element_text(size=15), 
                  axis.text.x = element_blank(), 
                  axis.text.y = element_blank(), plot.title = element_text(size = 12, face = "bold"))

rape_PP_stInt = ggplot() + geom_sf(data=map_stInt_RR_PP) + aes(fill=PP_cat) + theme_bw() +
    scale_fill_viridis(
    option = "plasma", name="PP",
    discrete = T,
    direction = -1,
    guide = guide_legend(
      title.position = 'top',
      reverse = T
    )) +  ggtitle("PP Spatio-temporal model with Interaction I") + theme(text = element_text(size=15), 
                  axis.text.x = element_blank(), 
                  axis.text.y = element_blank(), plot.title = element_text(size = 12, face = "bold")) 

```

# Model visualisation

### Full map visualisation - dowry 

```{r, fig.width=12, fig.height=12}
(dowry_RR_s | dowry_PP_s) / (dowry_RR_st | dowry_PP_st) / (dowry_RR_stInt | dowry_PP_stInt)

```

```{r, fig.width=12, fig.height=12}
(rape_RR_s | rape_PP_s) / (rape_RR_st | rape_PP_st) / (rape_RR_stInt | rape_PP_stInt)

```

### Temporal resRRs & CIs (rape & dowry)


```{r, fig.width=12, fig.height=4}

RR_stRW_dowry$year <- seq(2001, 2014)
RR_stRW_rape$year   <- seq(2001, 2014)
RR_stRW_dowry$Crime <- "Dowry Deaths"
RR_stRW_rape$Crime   <- "Rape"

RR_stRW_both <- rbind(RR_stRW_dowry, RR_stRW_rape)

RR_stInt_RW_dowry$year <- seq(2001, 2014)
RR_stInt_RW_rape$year   <- seq(2001, 2014)
RR_stInt_RW_dowry$Crime <- "Dowry Deaths"
RR_stInt_RW_rape$Crime   <- "Rape"

RR_stInt_RW_both <- rbind(RR_stInt_RW_dowry, RR_stInt_RW_rape)

temp_st_both <- ggplot(RR_stRW_both, aes(x = year, y = RR, colour = Crime, fill = Crime)) +
  geom_line() +
  geom_ribbon(aes(ymin = low_CI, ymax = up_CI), alpha = 0.2, colour = NA) +
  ggtitle("Spatio-temporal model") +
  theme_bw() +
  labs(x = "Year")

temp_stInt_both = ggplot(RR_stInt_RW_both, aes(x = year, y = RR, colour = Crime, fill = Crime)) +
  geom_line() +
  geom_ribbon(aes(ymin = low_CI, ymax = up_CI), alpha = 0.2, colour = NA) +
  ggtitle("Spatio-temporal model with Interaction I") +
  theme_bw() +
  labs(x = "Year")

temp_st_both | temp_stInt_both 

```

### Interactions map

```{r, fig.width=12, fig.height=10}

data_st$int_dowry = st_int_model_dowry$summary.random$ID_area_year$mean
data_st$int_dowry_cat = cut(data_st$int_dowry,  breaks=c(-1,-0.05, 
                  -0.01, 0.01, 0.05, 1),include.lowest = T)

data_st$int_rape = st_int_model_rape$summary.random$ID_area_year$mean
data_st$int_rape_cat = cut(data_st$int_rape,  breaks=c(-1,-0.05, 
                  -0.01, 0.01, 0.05, 1),include.lowest = T)

dowry_int_map =  ggplot() + geom_sf(data = data_st, aes(fill=int_dowry_cat)) + theme_bw() +
  scale_fill_brewer(palette = "PuOr") +
  guides(fill=guide_legend(title=NULL)) + 
  theme(text = element_text(size=20),
        axis.text.x = element_blank(), axis.text.y = element_blank()) +
facet_wrap(~ year, ncol = 4, labeller=labeller(ID_year=c("1"="2001","2"="2002","3"="2003","4"="2004","5"="2005",
                            "6"="2006","7"="2007","8"="2008","9"="2009","10"="2010",
                            "11"="2011","12"="2012","13"="2013","14"="2014"))) +
labs("")

rape_int_map =  ggplot() + geom_sf(data = data_st, aes(fill=int_rape_cat)) + theme_bw() +
  scale_fill_brewer(palette = "PuOr") +
  guides(fill=guide_legend(title=NULL)) + 
  theme(text = element_text(size=20),
        axis.text.x = element_blank(), axis.text.y = element_blank()) +
facet_wrap(~ year, ncol = 4, labeller=labeller(ID_year=c("1"="2001","2"="2002","3"="2003","4"="2004","5"="2005",
                            "6"="2006","7"="2007","8"="2008","9"="2009","10"="2010",
                            "11"="2011","12"="2012","13"="2013","14"="2014"))) +
labs("")

dowry_int_map
rape_int_map

```

### Total posterior RRs from ST+I model

#### Dowry

```{r, fig.width=12, fig.height=12}

data_st$RR_total_emarg_dowry <- mapply(function(area_idx, year_idx, area_year_idx) {
  rr_area <- inla.emarginal(function(x) exp(x), st_int_model_dowry$marginals.random$ID_area[[area_idx]])
  rr_year <- inla.emarginal(function(x) exp(x), st_int_model_dowry$marginals.random$ID_year[[year_idx]])
  rr_interaction <- inla.emarginal(function(x) exp(x), st_int_model_dowry$marginals.random$ID_area_year[[area_year_idx]])
  
  rr_area * rr_year * rr_interaction
},
area_idx = data_st$ID_area,
year_idx = data_st$ID_year,
area_year_idx = data_st$ID_area_year)


breaks_total = c(min(data_st$RR_total_emarg_dowry), 0.5, 1, 1.5, 2, 2.5, max(data_st$RR_total_emarg_dowry))
data_st$RR_total_cat_dowry = cut(data_st$RR_total_emarg_dowry,  breaks=breaks_total,include.lowest = T)

dowry_stInt_postRR = ggplot() + geom_sf(data = data_st, aes(fill = RR_total_cat_dowry)) + theme_bw() + scale_fill_brewer(palette = "PuOr") +
  guides(fill=guide_legend(title=NULL)) +
  theme(text = element_text(size=20),
        axis.text.x = element_blank(), axis.text.y = element_blank()) +
facet_wrap(~ year, ncol = 5, labeller=labeller(ID_year=c("1"="2001","2"="2002","3"="2003","4"="2004","5"="2005",
                            "6"="2006","7"="2007","8"="2008","9"="2009","10"="2010",
                            "11"="2011","12"="2012","13"="2013","14"="2014"))) +
labs(title = "Posterior Mean Relative Risks of Dowry Deaths")

dowry_stInt_postRR

```

#### rape

```{r, fig.width=12, fig.height=12}

data_st$RR_total_emarg_rape <- mapply(function(area_idx, year_idx, area_year_idx) {
  rr_area <- inla.emarginal(function(x) exp(x), st_int_model_rape$marginals.random$ID_area[[area_idx]])
  rr_year <- inla.emarginal(function(x) exp(x), st_int_model_rape$marginals.random$ID_year[[year_idx]])
  rr_interaction <- inla.emarginal(function(x) exp(x), st_int_model_rape$marginals.random$ID_area_year[[area_year_idx]])
  
  rr_area * rr_year * rr_interaction
},
area_idx = data_st$ID_area,
year_idx = data_st$ID_year,
area_year_idx = data_st$ID_area_year)


breaks_total = c(min(data_st$RR_total_emarg_rape), 0.5, 1, 1.5, 2, 2.5, max(data_st$RR_total_emarg_rape))
data_st$RR_total_cat_rape = cut(data_st$RR_total_emarg_rape,  breaks=breaks_total,include.lowest = T)

rape_stInt_postRR = ggplot() + geom_sf(data = data_st, aes(fill = RR_total_cat_rape)) + theme_bw() + scale_fill_brewer(palette = "PuOr") +
  guides(fill=guide_legend(title=NULL)) +
  theme(text = element_text(size=20),
        axis.text.x = element_blank(), axis.text.y = element_blank()) +
facet_wrap(~ year, ncol = 5, labeller=labeller(ID_year=c("1"="2001","2"="2002","3"="2003","4"="2004","5"="2005",
                            "6"="2006","7"="2007","8"="2008","9"="2009","10"="2010",
                            "11"="2011","12"="2012","13"="2013","14"="2014"))) +
labs(title = "Posterior Mean Relative Risks of Rapes")

rape_stInt_postRR

```

# Tables

### WAICs 

```{r}
WAIC_df = data.frame(model = c("Spatial", "Spatio-temporal", "Spatio-Temporal + Int"), 
                       WAIC_dowry = round(c(s_dowry_model$waic$waic, st_dowry_model$waic$waic, st_int_model_dowry$waic$waic)),
                        WAIC_rape = round(c(s_rape_model$waic$waic, st_rape_model$waic$waic, st_int_model_rape$waic$waic)))
colnames(WAIC_df) = c("Model", "WAIC (Dowry)", "WAIC (Rape)")                    
waic_table = knitr::kable(WAIC_df, caption = "Hyperparameter Summary for Different Models and Crimes") %>%
  kable_styling(bootstrap_options = "striped", full_width = F, position = "center")
waic_table
save_kable(waic_table, file = "waic_table.png")

```


### extract all hyperparameters

```{r}

# Combine hyperparameters into one table

rape_s_hyper = s_rape_model$summary.hyperpar
dowry_s_hyper = s_dowry_model$summary.hyperpar
rape_st_hyper = st_rape_model$summary.hyperpar
dowry_st_hyper = st_dowry_model$summary.hyperpar
rape_stInt_hyper = st_int_model_rape$summary.hyperpar
dowry_stInt_hyper = st_int_model_dowry$summary.hyperpar

# tidy up into dataframes: spatial
rape_s_df <- as.data.frame(rape_s_hyper) %>%
  mutate(Hyperparameter = rownames(rape_s_hyper),Crime = "Rape", Model = "Spatial")
dowry_s_df <- as.data.frame(dowry_s_hyper) %>%
  mutate(Hyperparameter = rownames(dowry_s_hyper),Crime = "Dowry",Model = "Spatial")

# spatio-temporal
rape_st_df <- as.data.frame(rape_st_hyper) %>%
  mutate(Hyperparameter = rownames(rape_st_hyper),Crime = "Rape",Model = "Spatio-temporal")
dowry_st_df <- as.data.frame(dowry_st_hyper) %>%
  mutate(Hyperparameter = rownames(dowry_st_hyper),Crime = "Dowry",Model = "Spatio-temporal")

# ST + interaction
rape_stInt_df <- as.data.frame(rape_stInt_hyper) %>%
  mutate(Hyperparameter = rownames(rape_stInt_hyper),Crime = "Rape",Model = "Spatio-temporal Interaction")
dowry_stInt_df <- as.data.frame(dowry_stInt_hyper) %>%
  mutate(Hyperparameter = rownames(dowry_stInt_hyper),Crime = "Dowry",Model = "Spatio-temporal Interaction")

# Combine dataframes
hyper_df <- bind_rows(rape_s_df, dowry_s_df,rape_st_df, dowry_st_df,rape_stInt_df, dowry_stInt_df)

knitr::kable(hyper_df, caption = "Hyperparameter Summary for Different Models and Crimes")

```

```{r}
ggplot(hyper_df, aes(x = Model, y = mean, color = Crime, group = Crime)) +
  geom_point(position = position_dodge(width = 0.5), size = 3) +
  geom_errorbar(aes(ymin = `0.025quant`, ymax = `0.975quant`),
                width = 0.2, position = position_dodge(width = 0.5)) +
  facet_wrap(~ Hyperparameter, scales = "free_y") +
  labs(title = "Hyperparameter Estimates by Model and Crime Type",
       y = "Estimate", x = "Model") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```


